{% extends "base.html" %}

{% block page_title %}Mark Attendance{% endblock %}

{% block extra_css %}
<style>
    .camera-container {
        background: #000;
        border-radius: 10px;
        overflow: hidden;
        max-width: 800px;
        margin: 0 auto 30px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        position: relative;
        min-height: 400px;
    }

    video {
        width: 100%;
        height: auto;
        display: block;
        background: #000;
    }

    canvas {
        display: none !important;
    }

    .controls {
        display: flex;
        gap: 15px;
        margin-bottom: 30px;
        flex-wrap: wrap;
        justify-content: center;
    }

    .controls button {
        padding: 15px 30px;
        font-size: 16px;
    }

    .marked-list {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        max-height: 400px;
        overflow-y: auto;
    }

    .marked-item {
        background: white;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 10px;
        border-left: 4px solid #27ae60;
    }

    .marked-item-name {
        font-weight: bold;
        color: #2c3e50;
        margin-bottom: 5px;
    }

    .marked-item-meta {
        font-size: 14px;
        color: #7f8c8d;
    }

    .message {
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
        text-align: center;
    }

    .message.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .message.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .message.warning {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }

    .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
    }

    .stat-label {
        font-size: 14px;
        opacity: 0.9;
    }

    .stat-value {
        font-size: 32px;
        font-weight: bold;
        margin-top: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="stats">
    <div class="stat">
        <div class="stat-label">Marked Today</div>
        <div class="stat-value" id="marked-count">0</div>
    </div>
    <div class="stat">
        <div class="stat-label">Total Students</div>
        <div class="stat-value" id="total-count">-</div>
    </div>
    <div class="stat" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
        <div class="stat-label">Remaining</div>
        <div class="stat-value" id="remaining-count">-</div>
    </div>
</div>

<div id="message-container"></div>

<div class="controls">
    <button class="btn btn-success" id="start-btn" onclick="startCamera()">
        üì∑ Start Camera
    </button>
    <button class="btn btn-danger" id="stop-btn" onclick="stopCamera()" style="display: none;">
        ‚èπÔ∏è Stop Camera
    </button>
    <button class="btn btn-primary" id="capture-btn" onclick="captureFrame()" style="display: none;">
        üì∏ Mark Attendance
    </button>
    <button class="btn" id="reset-btn" onclick="resetAttendance()" style="background: #e67e22;">
        üîÑ Reset Today
    </button>
</div>

<div class="camera-container">
    <video id="video" autoplay playsinline muted style="display: none;"></video>
    <canvas id="canvas" style="display: none;"></canvas>
    <div id="camera-placeholder" style="padding: 100px 20px; text-align: center; color: #7f8c8d;">
        <p style="font-size: 50px;">üìπ</p>
        <p>Click "Start Camera" to begin marking attendance</p>
    </div>
</div>

<h3 style="color: #2c3e50; margin-bottom: 15px;">‚úÖ Marked Students Today</h3>
<div class="marked-list" id="marked-list">
    <p style="text-align: center; color: #7f8c8d;">No students marked yet</p>
</div>

{% endblock %}

{% block extra_js %}
<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    let stream = null;

    async function startCamera() {
        try {
            console.log('Requesting camera access...');
            stream = await navigator.mediaDevices.getUserMedia({
                video: {
                    width: { ideal: 1280 },
                    height: { ideal: 720 },
                    facingMode: 'user'
                }
            });

            console.log('Camera access granted, setting up video...');
            video.srcObject = stream;

            // Wait for video metadata to load
            await video.play();

            console.log('Video playing, dimensions:', video.videoWidth, 'x', video.videoHeight);

            video.style.display = 'block';
            document.getElementById('camera-placeholder').style.display = 'none';

            document.getElementById('start-btn').style.display = 'none';
            document.getElementById('stop-btn').style.display = 'inline-block';
            document.getElementById('capture-btn').style.display = 'inline-block';

            // Load marked students
            loadMarkedStudents();

        } catch (error) {
            console.error('Camera error:', error);
            let errorMsg = 'Error accessing camera: ' + error.message;
            if (error.name === 'NotAllowedError') {
                errorMsg = 'Camera access denied. Please allow camera permissions.';
            } else if (error.name === 'NotFoundError') {
                errorMsg = 'No camera found. Please connect a webcam.';
            } else if (error.name === 'NotReadableError') {
                errorMsg = 'Camera is being used by another application.';
            }
            showMessage(errorMsg, 'error');
        }
    }

    function stopCamera() {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
        }

        video.style.display = 'none';
        document.getElementById('camera-placeholder').style.display = 'block';

        document.getElementById('start-btn').style.display = 'inline-block';
        document.getElementById('stop-btn').style.display = 'none';
        document.getElementById('capture-btn').style.display = 'none';
    }

    function captureFrame() {
        // Check if video is ready
        if (!video.videoWidth || !video.videoHeight) {
            showMessage('Camera is not ready yet. Please wait a moment and try again.', 'error');
            return;
        }

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0);

        const imageData = canvas.toDataURL('image/jpeg', 0.95);
        console.log('Frame captured, size:', imageData.length);
        markAttendance(imageData);
    }

    async function markAttendance(imageData) {
        try {
            document.getElementById('capture-btn').disabled = true;
            document.getElementById('capture-btn').textContent = '‚è≥ Processing...';

            const response = await fetch('/api/attendance/mark', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ image: imageData })
            });

            const data = await response.json();

            if (data.success) {
                showMessage(data.message, 'success');
                loadMarkedStudents();
            } else {
                showMessage(data.message, 'error');
            }

            document.getElementById('capture-btn').disabled = false;
            document.getElementById('capture-btn').textContent = 'üì∏ Mark Attendance';

        } catch (error) {
            showMessage('Error: ' + error.message, 'error');
            document.getElementById('capture-btn').disabled = false;
            document.getElementById('capture-btn').textContent = 'üì∏ Mark Attendance';
        }
    }

    async function loadMarkedStudents() {
        try {
            const response = await fetch('/api/attendance/today');
            const attendance = await response.json();

            const list = document.getElementById('marked-list');

            if (attendance.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #7f8c8d;">No students marked yet</p>';
            } else {
                list.innerHTML = attendance.map(a => `
                <div class="marked-item">
                    <div class="marked-item-name">${a.student_name}</div>
                    <div class="marked-item-meta">
                        Roll: ${a.student_roll} | Time: ${a.time.substring(0, 5)}
                    </div>
                </div>
            `).join('');
            }

            document.getElementById('marked-count').textContent = attendance.length;

            // Update remaining count
            const totalResponse = await fetch('/api/students');
            const students = await totalResponse.json();
            const totalCount = students.length;
            const remainingCount = totalCount - attendance.length;

            document.getElementById('total-count').textContent = totalCount;
            document.getElementById('remaining-count').textContent = remainingCount;

            // Show warning if no students registered
            if (totalCount === 0) {
                showMessage('No students registered. Please add students in Admin Panel first.', 'warning');
            }

        } catch (error) {
            console.error('Error loading students:', error);
        }
    }

    async function resetAttendance() {
        if (confirm('Are you sure? This will erase today\'s attendance records.')) {
            try {
                const response = await fetch('/api/attendance/reset', {
                    method: 'POST'
                });

                const data = await response.json();

                if (data.success) {
                    showMessage(data.message, 'success');
                    loadMarkedStudents();
                } else {
                    showMessage(data.message, 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }
    }

    function showMessage(message, type) {
        const container = document.getElementById('message-container');
        let messageClass = 'error';
        if (type === 'success') messageClass = 'success';
        else if (type === 'warning') messageClass = 'warning';

        container.innerHTML = `<div class="message ${messageClass}">${message}</div>`;

        setTimeout(() => {
            container.innerHTML = '';
        }, 5000);
    }

    // Load initial data on page load
    loadMarkedStudents();
</script>
{% endblock %}